<html>
<head>
  <title>DigIT! Root Detector</title>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="stylesheet" href="/static/thirdparty/semantic.min.css">
  <script src="/static/thirdparty/jquery-3.4.1.min.js"></script>
  <script src="/static/thirdparty/jquery.tmpl.min.js"></script>
  <script src="/static/thirdparty/semantic.min.js"></script>

  <script src="/static/util.js"></script>
  <script src="/static/settings.js"></script>
  <script src="/static/downloads.js"></script>
  <script src="/static/script.js"></script>
  <script src="/static/detection.js"></script>
  <script src="/static/tracking.js"></script>

  <script src="/static/thirdparty/jszip.min.js"></script>
  <script src="/static/thirdparty/UTIF.js"></script>


  <style>.ui.table td.active, .ui.table tr.active { background: #fff!important;  }</style>
  <style type="text/css">
    .unselectable {                        /*TODO: firefox bug*/
      user-drag: none; 
      user-select: none;
      -moz-user-select: none;
      -webkit-user-drag: none;
      -webkit-user-select: none;
      -ms-user-select: none;
    }

    .pixelated {
      -ms-interpolation-mode: nearest-neighbor;
      image-rendering: pixelated;
    }

    .left.view-box{
      margin-right:2px;
    }
    .right.view-box{
      margin-left:2px;
    }
  </style>


  <template id="progress-dimmer">
    <div class="ui dimmer">
      <div class="content">
        <h2 class="ui inverted icon header">
          <i class="spinner loading icon"></i>
          <p>Processing...</p>
        </h2>
      </div>
    </div>
  </template>

</head>








<body onload="init()">

  
  <div class="ui container menu" style="width:calc(100% - 40px);">
    <!--<div class="header item">DigIT! Root Detector</div>-->

    <div class="ui simple dropdown item">
      <span class="text">Files</span>
      <i class="dropdown icon"></i>
      <div class="ui menu">
        <label for="input_images" class="ui icon item">
          <i class="images outline icon"></i>
          Select Input Images
        </label>
        <input type="file" id="input_images" style="display:none"
              onchange="on_inputfiles_select(event)" accept="image/*" multiple>
        
        <label for="input_folder" class="ui icon item">
          <i class="folder outline icon"></i>
          Select Input Folder
        </label>
        <input type="file" id="input_folder" style="display:none"
              onchange="on_inputfolder_select(this)"  webkitdirectory directory multiple>
        <div class="divider"></div>

        <label for="input_masks" class="ui icon item">
          <i class="images icon"></i>
          Select Exclude Masks
        </label>
        <input type="file" id="input_masks" style="display:none" onclick="this.value=null;"
              onchange="on_inputmasks_select(event)" accept="image/*" multiple>

      </div>
    </div>

    <div class="item">
    <div class="buttons">
    <label class="ui primary button" onclick="process_all()" id="process-all-button">
        <i class="play icon"></i>
        Process All Images
    </label>
    <label class="ui red button" id="cancel-button" style="display:none;">
        <i class="x icon"></i>
        Cancel
    </label>
    </div>
    </div>
    

    <div class="ui secondary right menu">
      <div class="item">
        <div class="ui buttons">
        
        <label class="ui icon button right floated column" id="download-button" data-position="bottom right">
          <i class="download icon"></i>
        </label>
        <div class="ui popup transition hidden vertical menu" style="padding:0">
            <a class="item" onclick="on_download_processed()"     id="download-processed-button"     
              style="align-self:auto;margin:0px"> Download Segmented Images</a>
            <a class="item" onclick="on_download_csv()" id="download-csv-button" 
              style="align-self:auto;margin:0px">
              Download Statistics</a>
        </div>
        <script>$('#download-button').popup({hoverable:true});</script>

        <label class="ui button" onclick="on_settings()"
              id="settings-button" data-tooltip="Settings" data-position="bottom center">
          <i class="wrench icon"></i>
        </label>
        </div>
      </div>
    </div>
  </div>



<div class="ui container" style="width:calc(100% - 40px); padding-bottom:50vh;">
  <div class="ui top attached tabular menu">
    <a class="active item" data-tab="first">Root Detection</a>
    <a class="item" data-tab="second">Root Tracking</a>
  </div>


  <div class="ui bottom attached active tab" data-tab="first">
    <!-- Root Detection Tab -->
    <table class="ui basic celled table accordion" id="filetable" style="border-top-width: 0px;">
      <tbody>
        <tr>
          <td>No files loaded</td>
          <td></td>
        </tr>

        <template id="filetable-item-template">
          <tr class="ui title" filename="${filename}">
            <td style="width:100%;"> 
              <i class="dropdown icon"></i>
              <i class="icons"  style="font-style: normal;">
                <i class="image outline icon" title="File not yet processed"></i>
                <i class="top left corner red add icon has-mask-indicator" style="display:none"></i>
                <label>${filename}</label>
              </i>
            </td>

            <td style="display:flex; justify-content: space-around;" onclick="event.stopPropagation();">
              <i class="grey close icon"></i>
            </td>
          </tr>
          <tr style="display:none" filename="${filename}">
            <td colspan="5" class="ui content" style="padding:0px; padding-bottom:10px"">
              <div class="loading-message" style="display:flex;justify-content: center;">
                <i class="spinner loading icon"></i>
                Loading...
              </div>

              <div class="content">
                <div class="ui bottom attached secondary icon menu" style="border-top-width: 0px;">
                  <a class="item" onclick="RootDetection.on_process_image(event)"><i class="play icon"></i></a>

                  <a class="item view-menu-button" data-position="bottom left">
                    <i class="eye icon"></i>
                  </a>
                  <div class="ui popup view-menu-popup">
                    <div class="ui disabled checkbox skeletonized-checkbox">
                      <input type="checkbox">
                      <label>Skeletonized</label>
                    </div>
                  </div>
                  <script>$('.view-menu-button').last().popup({hoverable:true});</script>
                  <script>$('.skeletonized-checkbox').last().checkbox();</script>

                  <!--<a class="item" onclick="on_download_tracking_single(event)"><i class="download icon"></i></a>-->
                </div>

                <div style="display: flex; align-items: flex-start; justify-content: center;" >

                  <div class="input-image" style="max-width:50%; margin-right:2px;">
                    <img class="input-image unselectable pixelated" style="max-width:100%; max-height:90vh;">
                  </div>
                  <div class="detection-result" style="max-width:50%; margin-left:2px;">
                    <img class="detection-result unselectable" style="max-width:100%; max-height:90vh;">
                    {{tmpl({}) "#progress-dimmer"}}
                  </div>
                
                </div>
              </div>
            </td>
          </tr>
        </template>

      </tbody>
    </table>
  </div>



  <div class="ui bottom attached tab" data-tab="second">
    <!-- Root Tracking Tab -->
    <table class="ui basic celled table accordion" id="tracking-filetable" style="border-top-width: 0px;">
      <tbody>
        <tr class="ui">
          <td>No files loaded</td>
          <td></td>
        </tr>

        <template id="tracking-item">
          <tr class="ui title" filename0="${filename0}" filename1="${filename1}">
            <td style="width:50%;"> 
              <i class="dropdown icon"></i>
              <label>${filename0}</label>
            </td>
            <td style="width:50%;">
              <label>${filename1}</label>
            </td>

            <td style="display:flex; justify-content: space-around;" onclick="event.stopPropagation();">
              <i class="grey close icon"></i>
            </td>
          </tr>

          <tr style="display:none" filename0="${filename0}" filename1="${filename1}">
            <td colspan="5" class="ui content" style="padding:0px; padding-bottom:10px;">
              <div class="ui bottom attached secondary icon menu" style="border-top-width: 0px;">
                <a class="item" onclick="RootTracking.on_process_clicked(event)"><i class="play icon"></i></a>

                <a class="item" onclick="RootTracking.on_apply_corrections(event)"><i class="check icon"></i></a>

                <a class="item view-menu-button" data-position="bottom left">
                  <i class="eye icon"></i>
                </a>
                <div class="ui flowing popup view-menu-popup">
                  <div class="ui disabled checkbox show-growthmap-checkbox">
                    <input type="checkbox">
                    <label>Show growth map</label>
                  </div>
                  <div class="ui divider" style="border:0px;"></div>
                  <div class="ui disabled checkbox show-matched-points-checkbox">
                    <input type="checkbox">
                    <label>Show matched points</label>
                  </div>
                  <div class="ui divider" style="border:0px;"></div>
                  <div class="ui disabled checkbox show-skeleton-points-checkbox">
                    <input type="checkbox">
                    <label>Show skeleton points</label>
                  </div>
                </div>
                <script>
                  $('.view-menu-button').last().popup({hoverable:true});
                  $('.view-menu-popup').last().find('.checkbox').checkbox();
                </script>

                <a class="item" onclick="on_download_tracking_single(event)"><i class="download icon"></i></a>

                <a class="item"><i class="help icon"></i></a>
              </div>
              <div style="display: flex; align-items: flex-start; justify-content: center;" >
                {{tmpl({position:"left"})  "#tracking-image"}}
                {{tmpl({position:"right"}) "#tracking-image"}}
                {{tmpl({}) "#progress-dimmer"}}
              </div>
            </td>
          </tr>
        </template>
      
        <template id="tracking-image">
          <div class="unselectable view-box ${position}"
               style="max-width:50%; position:relative; overflow:hidden; background-color:grey;"
               ondblclick ="RootTracking.on_svg_dblclick(event)">
            <div class="transform-box" style="transform: matrix(1,0,0,1,0,0)"
                 onmousedown="RootTracking.on_svg_mousedown(event)"
                 onmousemove="RootTracking.on_svg_mousemove(event)"
                 onwheel    ="RootTracking.on_svg_wheel(event)">
              <img  class="${position} input-image unselectable pixelated" style="max-width:100%; max-height:90vh; pointer-events: none;">
              <img  class="${position} overlay unselectable pixelated" 
                    style="position:absolute; top:0px; left:0px; width:100%; height:100%; pointer-events:none; display:none;">
              <svg  class="${position} tracking-overlay-svg"
                    style="position:absolute; pointer-events: none;
                           top:0px; left:0px; 
                           width:100%; height:100%;"
                    viewBox="0 0 1 1">  <!--viewBox adjusted in javascript-->
              
                <circle class="cursor" cx="0" cy="0" r="0px" fill="red" />
               <!--points="" adjusted in javascript-->
               <polyline class="matched-points" points="" fill="none" stroke="none" 
                marker-start="url(#dot-marker)" marker-mid="url(#dot-marker)" marker-end="url(#dot-marker)" />
             </svg>
            </div>
          </div>
        </template>

      </tbody>
    </table>
  </div>
</div>
<script>$('#filetable').accordion({duration:0, onOpening:RootDetection.on_accordion_open});</script>
<script>$('#tracking-filetable').accordion({duration:0, onOpening:RootTracking.on_accordion_open});</script>
<script>$('.menu.tabular .item').tab();</script>





<!-- Settings -->
<div class="ui tiny modal" id="settings-dialog">
  <i class="close icon"></i>
  <div class="header"> Settings </div>

  <div class="ui form content">
    <!--<div class="field">
      <label>Skeletonization</label>
      <div class="ui toggle checkbox" id="settings-skeletonize">
        <input type="checkbox">
        <label>Enable skeletonization of segmented roots</label>
      </div>
    </div>-->
    
    <div class="field">
      <label>Root detection model</label>
      <div class="ui dropdown selection" id="settings-active-model">
        <input type="hidden" name="active-model">
        <i class="dropdown icon"></i>
        <div class="default text">Segmentation model</div>
        <div class="menu">
          <!--<div class="item" data-value="1">model_1</div>
          <div class="item" data-value="0">model_2</div>-->
        </div>
      </div>
    </div>

    <div class="ui divider"></div>
    <div class="field">
      <label>Exclusion mask</label>
      <div class="ui toggle checkbox" id="settings-exclusionmask-enable">
        <input type="checkbox">
        <label>Enable detection of foreign objects (e.g. tape)</label>
      </div>
    </div>

    <div class="field" id="settings-exclusionmask-model-field" style="display:none">
      <label>Exclusion mask model</label>
      <div class="ui dropdown selection" id="settings-exclusionmask-model">
        <input type="hidden" name="active-model">
        <i class="dropdown icon"></i>
        <div class="default text">Exclusion mask model</div>
        <div class="menu">
          <!--<div class="item" data-value="1">model_1</div>
          <div class="item" data-value="0">model_2</div>-->
        </div>
      </div>
    </div>

    <div class="ui divider"></div>
    <div class="field" id="settings-tracking-model-field">
      <label>Root tracking model</label>
      <div class="ui dropdown selection" id="settings-tracking-model">
        <input type="hidden" name="active-model">
        <i class="dropdown icon"></i>
        <div class="default text">Root tracking model</div>
        <div class="menu">
          <!--<div class="item" data-value="1">model_1</div>
          <div class="item" data-value="0">model_2</div>-->
        </div>
      </div>
    </div>

   <div class="actions">
      <div class="ui negative button">
        Cancel
      </div>
      <div class="ui positive right labeled icon button" id="settings-ok-button">
        Save
        <i class="checkmark icon"></i>
      </div>
    </div>
  </div>
</div>

<svg style="position:absolute" id="svg-defs">
  <defs>
    <marker id="dot-marker" viewBox="0 0 4 4" refX="2" refY="2" markerHeight="2" markerWidth="2">
      <circle r="2" cx="2" cy="2" fill="blue"></circle>
    </marker>
    <marker id="dot-marker-red" viewBox="0 0 2 2" refX="1" refY="1" markerHeight="1" markerWidth="1">
      <circle r="1" cx="1" cy="1" fill="red"></circle>
    </marker>
    <marker id="dot-marker-green" viewBox="0 0 2 2" refX="1" refY="1" markerHeight="1" markerWidth="1">
      <circle r="1" cx="1" cy="1" fill="green"></circle>
    </marker>
  </defs>
</svg>

</body>
</html>
